-- Liste des coffres
local chests = {}
local items = {}

-- Récupérer les coffres
for _, name in ipairs(peripheral.getNames()) do
    local pType = peripheral.getType(name)
    if pType == "minecraft:chest" then
        table.insert(chests, peripheral.wrap(name))
    end
end

-- Fonction pour trier les items
local function sortItems()
    local itemList = {}

    -- Collecte tous les items de tous les coffres
    for _, chest in ipairs(chests) do
        local chestItems = chest.list()
        for slot, item in pairs(chestItems) do
            table.insert(itemList, {name = item.name, count = item.count, chest = chest, slot = slot})
        end
    end

    -- Trier par nom, puis par quantité
    table.sort(itemList, function(a, b)
        if a.name == b.name then
            return a.count > b.count  -- Si même nom, trier par quantité (du plus grand au plus petit)
        else
            return a.name < b.name  -- Trier alphabétiquement par nom
        end
    end)

    return itemList
end

-- Fonction pour déplacer les items entre les coffres
local function pushItems(itemList)
    for i, item in ipairs(itemList) do
        local itemName = item.name
        local itemCount = item.count
        local currentChest = item.chest
        local currentSlot = item.slot

        -- Cherche un coffre pour transférer l'item
        for _, targetChest in ipairs(chests) do
            if targetChest ~= currentChest then
                -- Vérifier si l'espace est disponible dans le coffre cible
                local targetSlot = targetChest.getFreeSlot()
                if targetSlot then
                    -- Si l'item est dans un coffre différent et a de la place
                    print("Transfert de " .. itemCount .. "x " .. itemName .. " de " .. tostring(currentChest) .. " vers " .. tostring(targetChest))
                    currentChest.pushItems(targetChest, currentSlot, targetSlot, itemCount)
                    break
                end
            end
        end
    end
end

-- Fonction principale pour trier et transférer
local function autoSortChests()
    print("Début du tri des coffres...")

    -- Trier les items par ordre alphabétique et quantité
    local sortedItems = sortItems()

    -- Déplacer les items pour remplir les coffres en priorité
    pushItems(sortedItems)

    print("Tri terminé !")
end

-- Lancer le tri automatique
autoSortChests()
