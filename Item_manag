-- Détecter tous les coffres connectés
local chests = {}
for _, name in ipairs(peripheral.getNames()) do
    local pType = peripheral.getType(name)
    if pType == "minecraft:chest" then
        table.insert(chests, peripheral.wrap(name))
    end
end

-- Fonction pour trier les items par ordre alphabétique
local function getSortedItems()
    local items = {}
    
    -- Récupérer les items de tous les coffres
    for _, chest in ipairs(chests) do
        local chestItems = chest.list()
        for slot, item in pairs(chestItems) do
            table.insert(items, {name = item.name, count = item.count, slot = slot, chest = chest})
        end
    end
    
    -- Trier les items par nom
    table.sort(items, function(a, b)
        return a.name < b.name
    end)
    
    return items
end

-- Fonction pour redistribuer les items triés dans les coffres
local function distributeItems(sortedItems)
    local currentChestIndex = 1
    local currentChest = chests[currentChestIndex]
    
    for _, item in ipairs(sortedItems) do
        -- Vérifier si l'item peut être déplacé dans le coffre actuel
        local currentSlot = currentChest.getItemDetail(item.slot)
        
        -- Si le coffre a un item dans ce slot
        if currentSlot and currentSlot.name == item.name then
            -- Ajouter les items au coffre courant (si de la place)
            local freeSpace = currentChest.getSlotMaxStackSize(item.slot) - currentSlot.count
            local transferCount = math.min(item.count, freeSpace)
            if transferCount > 0 then
                currentChest.pushItems(item.chest, item.slot, transferCount)
                item.count = item.count - transferCount
            end
        end

        -- Si l'item est encore disponible après l'essai d'ajout
        if item.count > 0 then
            -- Passer au coffre suivant
            currentChestIndex = currentChestIndex + 1
            if currentChestIndex <= #chests then
                currentChest = chests[currentChestIndex]
            else
                break
            end
        end
    end
end

-- Fonction principale de tri et de distribution
local function sortAndDistribute()
    -- Récupérer les items triés
    local sortedItems = getSortedItems()

    -- Distribuer les items entre les coffres
    distributeItems(sortedItems)
end

-- Exécuter le tri et la distribution des items
sortAndDistribute()
